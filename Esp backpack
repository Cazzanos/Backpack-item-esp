local targetItemNames = {"M9", "Handcuffs", "Keycard", "Fal", "AR 15", "Glock", "Taser"}
local RunService = game:GetService("RunService")

local staticTick = 0  -- Inițializăm staticTick aici pentru a evita nil

local function getTargetItemNames(player)
    local targetItems = {}
    
    local backpack = player:FindFirstChild("Backpack")
    if backpack then
        for _, item in pairs(backpack:GetChildren()) do
            local itemName = item.Name
            for _, targetItem in ipairs(targetItemNames) do
                if itemName == targetItem then
                    table.insert(targetItems, itemName)
                    break
                end
            end
        end
    end
    
    local character = player.Character
    if character then
        for _, item in pairs(character:GetChildren()) do
            if item:IsA("Tool") then
                local itemName = item.Name
                for _, targetItem in ipairs(targetItemNames) do
                    if itemName == targetItem then
                        table.insert(targetItems, itemName)
                        break
                    end
                end
            end
        end
    end
    
    return targetItems
end

local function adjustTextSizeBasedOnDistance(player, textLabel)
    local localPlayer = game.Players.LocalPlayer
    local character = localPlayer.Character
    local playerCharacter = player.Character

    if character and playerCharacter and character:FindFirstChild("HumanoidRootPart") and playerCharacter:FindFirstChild("HumanoidRootPart") then
        local distance = (character.HumanoidRootPart.Position - playerCharacter.HumanoidRootPart.Position).Magnitude
        local newSize = math.clamp(4 - (distance / 50), 1, 2)
        textLabel.TextSize = newSize * 10
    end
end

local function createOrUpdateBackpackESP(player)
    local character = player.Character
    if not character or player == game.Players.LocalPlayer then
        return
    end
    
    local existingESP = character:FindFirstChild("BackpackESP")
    if existingESP then
        existingESP:Destroy()
    end
    
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "BackpackESP"
    billboardGui.Adornee = character:FindFirstChild("Head")
    billboardGui.Size = UDim2.new(4, 0, 1, 0)
    billboardGui.StudsOffset = Vector3.new(0, 2, 0)
    billboardGui.AlwaysOnTop = true 
    billboardGui.ExtentsOffset = Vector3.new(0, 1, 0)

    local textLabel = Instance.new("TextLabel", billboardGui)
    textLabel.TextColor3 = Color3.new(1, 1, 1) 
    textLabel.BackgroundTransparency = 1
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.TextScaled = false
    textLabel.TextSize = 20 

    local targetItems = getTargetItemNames(player)
    local itemText = table.concat(targetItems, ", ")

    textLabel.Text = itemText ~= "" and "Items: " .. itemText or ""

    adjustTextSizeBasedOnDistance(player, textLabel)

    billboardGui.Parent = character
end

local function updateESPForAllPlayers()
    for _, player in pairs(game:GetService("Players"):GetPlayers()) do
        createOrUpdateBackpackESP(player)
    end
end

local function onItemChanged(player)
    createOrUpdateBackpackESP(player)
end

-- Conectăm funcția la evenimentele relevante
game:GetService("Players").PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        createOrUpdateBackpackESP(player)
        
        local backpack = player:WaitForChild("Backpack")
        backpack.ChildAdded:Connect(function()
            onItemChanged(player)
        end)
        backpack.ChildRemoved:Connect(function()
            onItemChanged(player)
        end)
        
        character.ChildAdded:Connect(function()
            onItemChanged(player)
        end)
        character.ChildRemoved:Connect(function()
            onItemChanged(player)
        end)
    end)
end)

-- Actualizăm ESP-ul pentru toți jucătorii o dată la 5 secunde
RunService.Heartbeat:Connect(function()
    staticTick = staticTick + 1
    if staticTick >= 5 then
        updateESPForAllPlayers()
        staticTick = 0
    end
end)
